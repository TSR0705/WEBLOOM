# Notifier Agent

The Notifier Agent is responsible for delivering alerts and notifications when significant events occur in the Webloom scraping pipeline. These include:

- content changes
- price drops or increases
- first-time discoveries
- job errors or failures
- worker health warnings

This agent acts as the communication bridge between the Webloom backend and the user, ensuring that insights generated by the pipeline translate into actionable updates.

It is built for reliability, low latency, and free-tier operability.

## ğŸ¯ Purpose

The Notifier Agent:

- listens for alerts from Change Detector and Price Tracker
- formats event messages
- sends notifications via multiple channels
- rate-limits notifications to avoid spamming
- stores notification logs (optional)
- ensures delivery reliability

Supported channels initially include:

- Email (SMTP or service API like Resend / Mailersend free tier)
- Telegram Bot notifications
- Dashboard live event feed (SSE)

More channels can be added via plugin architecture.

## ğŸ§© Input Queue
`notify`

Example incoming message:

```json
{
  "jobId": "abc123",
  "url": "https://example.com/product/5",
  "type": "price_change",
  "details": {
    "previous": 82000,
    "current": 79999,
    "percent": -2.56
  },
  "ts": 1712345678910
}
```

## ğŸ“­ Outputs

1. Email notification (if enabled)
2. Telegram message (if enabled)
3. Web dashboard event
4. Database logging (optional)

There is no output queue; notifications are the end of this branch.

## âœ‰ï¸ Supported Notification Types

| Event | Description |
|-------|-------------|
| price_change | Price goes up or down |
| content_change | Text or structural changes detected |
| new_version | New version stored even without major changes |
| job_error | Scraper or parser failed |
| job_completed | A job finished execution |
| job_paused | User or system paused job |
| system_warning | Worker unhealthy / queue overflow |

## ğŸ’¬ Notification Routing Logic

```
receive alert event
      â”‚
      â–¼
check user notification settings
      â”‚
      â”œâ”€â”€ email enabled â†’ send email
      â”‚
      â”œâ”€â”€ telegram enabled â†’ send telegram
      â”‚
      â””â”€â”€ dashboard SSE â†’ always send
      â–¼
record notification in DB (optional)
```

## ğŸ›¡ Rate Limiting / Spam Protection

To avoid overwhelming users:

Default limits:

- max 1 notification per URL every 5 minutes
- max 3 notifications per job every 10 minutes
- price changes require â‰¥ 1% difference

Flood protection ensures free-tier SMTP limits are respected.

## ğŸ“§ Email Notification Format

Subject:

```
[Webloom Alert] Price Drop Detected for iPhone 13
```

Body Example:

```
Product: Apple iPhone 13
URL: https://example.com/p/12

Price changed:
Old: â‚¹82,000
New: â‚¹79,999
Change: -2.56%

Detected at: 2024-01-01 12:00 IST
Job ID: abc123

---
Webloom Automated Monitoring
```

## ğŸ¤– Telegram Notification Format

```
ğŸ“‰ PRICE DROP DETECTED!

Product: Apple iPhone 13
Old: â‚¹82,000
New: â‚¹79,999
Change: -2.56%

ğŸ”— https://example.com/p/12
ğŸ•’ 2024-01-01 12:00 IST
```

Free tierâ€“friendly due to low API overhead.

## ğŸŒ Dashboard Live Notifications (SSE)

Dashboard receives event like:

```json
{
  "event": "price_change",
  "jobId": "abc123",
  "url": "https://example.com/product/5",
  "details": {...}
}
```

This powers the live activity feed.

## ğŸ” Retries & Failure Handling

| Failure | Response |
|---------|----------|
| Email provider timeout | retry (3x) |
| Telegram API rate-limit | exponential backoff |
| Invalid user settings | skip |
| Missing contact info | skip |
| Messaging API failure | DLQ route |

## âš™ï¸ Environment Variables

```
RABBIT_URL=amqp://guest:guest@rabbitmq:5672
INPUT_QUEUE=notify

SMTP_HOST=smtp.example.com
SMTP_USER=...
SMTP_PASS=...

TELEGRAM_BOT_TOKEN=...
TELEGRAM_CHAT_ID=...

NOTIFICATION_RATE_LIMIT_MINUTES=5
```

## ğŸ§ª Testing Strategy

### Unit Tests

- email formatting
- telegram message formatting
- rate limit enforcement
- notification type routing

### Integration Tests

- test SMTP provider (dummy)
- test Telegram sandbox
- test SSE event emission
- simulate multiple changes

### Negative Tests

- invalid email
- missing telegram token
- SMTP failure

## ğŸ§± Free-Tier Optimization

- email services with free monthly limits (Resend, Mailersend, etc.)
- telegram bot API is free
- low-memory agent design
- batch-processing to avoid API flooding

## ğŸ“ Summary

The Notifier Agent ensures Webloom remains proactive and useful by delivering:

- real-time change alerts
- actionable price updates
- job success/failure reports
- multi-channel communication

It provides the "human interface" for the distributed scraping pipeline.

END OF FILE